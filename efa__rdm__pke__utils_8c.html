<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>Libfabric EFA Provider: prov/efa/src/rdm/efa_rdm_pke_utils.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Libfabric EFA Provider
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_b381ef8083dea485196d236b9877555e.html">prov</a></li><li class="navelem"><a class="el" href="dir_a515239317c856b6e80d7e87f6229fcf.html">efa</a></li><li class="navelem"><a class="el" href="dir_268213be7ca109d6848bb43595209f5b.html">src</a></li><li class="navelem"><a class="el" href="dir_2a8709364a10ee80619c78ae399489f1.html">rdm</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">efa_rdm_pke_utils.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;rdma/fi_rma.h&gt;</code><br/>
<code>#include &quot;ofi_iov.h&quot;</code><br/>
<code>#include &quot;<a class="el" href="efa_8h_source.html">efa.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="efa__mr_8h_source.html">efa_mr.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="efa__hmem_8h_source.html">efa_hmem.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="efa__device_8h_source.html">efa_device.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="efa__rdm__ep_8h_source.html">efa_rdm_ep.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="efa__rdm__pke_8h_source.html">efa_rdm_pke.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="efa__rdm__pke__cmd_8h_source.html">efa_rdm_pke_cmd.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="efa__rdm__pke__rtm_8h_source.html">efa_rdm_pke_rtm.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="efa__rdm__pke__nonreq_8h_source.html">efa_rdm_pke_nonreq.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="efa__rdm__pke__utils_8h_source.html">efa_rdm_pke_utils.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="efa__rdm__pkt__type_8h_source.html">efa_rdm_pkt_type.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="efa__rdm__protocol_8h_source.html">efa_rdm_protocol.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="efa__rdm__pke__req_8h_source.html">efa_rdm_pke_req.h</a>&quot;</code><br/>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a25b95f35388c9960a72aebfc86b700f1"><td class="memItemLeft" align="right" valign="top">ssize_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="efa__rdm__pke__utils_8c.html#a25b95f35388c9960a72aebfc86b700f1">efa_rdm_pke_init_payload_from_ope</a> (struct <a class="el" href="structefa__rdm__pke.html">efa_rdm_pke</a> *pke, struct <a class="el" href="structefa__rdm__ope.html">efa_rdm_ope</a> *ope, size_t payload_offset, size_t segment_offset, size_t data_size)</td></tr>
<tr class="memdesc:a25b95f35388c9960a72aebfc86b700f1"><td class="mdescLeft">&#160;</td><td class="mdescRight">initialize the payload, payload_size, payload_mr and pkt_size of an outgoing packet  <a href="#a25b95f35388c9960a72aebfc86b700f1">More...</a><br/></td></tr>
<tr class="separator:a25b95f35388c9960a72aebfc86b700f1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5fc45cc402e5f6d10ebb6c81f1b8ca2b"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="efa__rdm__pke__utils_8c.html#a5fc45cc402e5f6d10ebb6c81f1b8ca2b">efa_rdm_ep_flush_queued_blocking_copy_to_hmem</a> (struct <a class="el" href="structefa__rdm__ep.html">efa_rdm_ep</a> *ep)</td></tr>
<tr class="memdesc:a5fc45cc402e5f6d10ebb6c81f1b8ca2b"><td class="mdescLeft">&#160;</td><td class="mdescRight">flush queued blocking copy to hmem  <a href="#a5fc45cc402e5f6d10ebb6c81f1b8ca2b">More...</a><br/></td></tr>
<tr class="separator:a5fc45cc402e5f6d10ebb6c81f1b8ca2b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a57f379a9e77f079c48cd0444aa7eb12d"><td class="memItemLeft" align="right" valign="top">ssize_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="efa__rdm__pke__utils_8c.html#a57f379a9e77f079c48cd0444aa7eb12d">efa_rdm_pke_copy_payload_to_ope</a> (struct <a class="el" href="structefa__rdm__pke.html">efa_rdm_pke</a> *pke, struct <a class="el" href="structefa__rdm__ope.html">efa_rdm_ope</a> *ope)</td></tr>
<tr class="memdesc:a57f379a9e77f079c48cd0444aa7eb12d"><td class="mdescLeft">&#160;</td><td class="mdescRight">copy data to application's receive buffer and update counter in rxe.  <a href="#a57f379a9e77f079c48cd0444aa7eb12d">More...</a><br/></td></tr>
<tr class="separator:a57f379a9e77f079c48cd0444aa7eb12d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa87aea9145046aaacca12d020cd95c3c"><td class="memItemLeft" align="right" valign="top">size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="efa__rdm__pke__utils_8c.html#aa87aea9145046aaacca12d020cd95c3c">efa_rdm_pke_get_payload_offset</a> (struct <a class="el" href="structefa__rdm__pke.html">efa_rdm_pke</a> *pke)</td></tr>
<tr class="memdesc:aa87aea9145046aaacca12d020cd95c3c"><td class="mdescLeft">&#160;</td><td class="mdescRight">determine the payload offset of a received packet.  <a href="#aa87aea9145046aaacca12d020cd95c3c">More...</a><br/></td></tr>
<tr class="separator:aa87aea9145046aaacca12d020cd95c3c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abcd01c4f245ce4ab51a78872ab8be0bb"><td class="memItemLeft" align="right" valign="top">uint32_t *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="efa__rdm__pke__utils_8c.html#abcd01c4f245ce4ab51a78872ab8be0bb">efa_rdm_pke_connid_ptr</a> (struct <a class="el" href="structefa__rdm__pke.html">efa_rdm_pke</a> *pke)</td></tr>
<tr class="memdesc:abcd01c4f245ce4ab51a78872ab8be0bb"><td class="mdescLeft">&#160;</td><td class="mdescRight">return the optional connid header pointer in a packet  <a href="#abcd01c4f245ce4ab51a78872ab8be0bb">More...</a><br/></td></tr>
<tr class="separator:abcd01c4f245ce4ab51a78872ab8be0bb"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a5fc45cc402e5f6d10ebb6c81f1b8ca2b"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int efa_rdm_ep_flush_queued_blocking_copy_to_hmem </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structefa__rdm__ep.html">efa_rdm_ep</a> *&#160;</td>
          <td class="paramname"><em>ep</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>flush queued blocking copy to hmem </p>
<p>The copying of data from bounce buffer to hmem receiving buffer is queued, and we copy them in batch.</p>
<p>This functions is used to flush all the queued hmem copy.</p>
<p>It can be called in two scenarios:</p>
<ol type="1">
<li>the number of queued hmem copy reached limit</li>
<li>all the data of one of the queued message has arrived.</li>
</ol>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">ep</td><td>endpoint, where queue_copy_num and queued_copy_vec reside. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="abcd01c4f245ce4ab51a78872ab8be0bb"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint32_t* efa_rdm_pke_connid_ptr </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structefa__rdm__pke.html">efa_rdm_pke</a> *&#160;</td>
          <td class="paramname"><em>pke</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>return the optional connid header pointer in a packet </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">pke</td><td>an packet entry </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>If the input has the optional connid header, return the pointer to connid header Otherwise, return NULL </dd></dl>

</div>
</div>
<a class="anchor" id="a57f379a9e77f079c48cd0444aa7eb12d"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">ssize_t efa_rdm_pke_copy_payload_to_ope </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structefa__rdm__pke.html">efa_rdm_pke</a> *&#160;</td>
          <td class="paramname"><em>pke</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structefa__rdm__ope.html">efa_rdm_ope</a> *&#160;</td>
          <td class="paramname"><em>ope</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>copy data to application's receive buffer and update counter in rxe. </p>
<p>Depend on when application's receive buffer is located (host or device) and the software stack, this function will select different, strategies to copy data.</p>
<p>When application's receive buffer is on device, there are two scenarios:</p>
<p>If memory is on cuda GPU, and gdrcopy is not available, this function will post a local read request to copy data. (This is because NCCL forbids its plugin to make cuda calls). In this case, the data is not copied upon return of this function, and the function <a class="el" href="efa__rdm__pke__cmd_8c.html#ac809cca77136c46cc4de7352a796095c" title="handle the event that data has been copied to the user buffer ">efa_rdm_pke_handle_data_copied()</a> is not called. It will be called upon the completion of local read operation by the progress engine.</p>
<p>Otherwise, this function calls efa_rdm_pke_copy_payload_to_hmem(), which will batch multiple copies, and perform the copy (then call <a class="el" href="efa__rdm__pke__cmd_8c.html#ac809cca77136c46cc4de7352a796095c" title="handle the event that data has been copied to the user buffer ">efa_rdm_pke_handle_data_copied()</a>) together to improve performance.</p>
<p>When application's receive buffer is on host, data is copied immediately, and <a class="el" href="efa__rdm__pke__cmd_8c.html#ac809cca77136c46cc4de7352a796095c" title="handle the event that data has been copied to the user buffer ">efa_rdm_pke_handle_data_copied()</a> is called.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">pke</td><td>the packet entry that contains data </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">ope</td><td>ope contains information of the receive buffer. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>On success, return 0 On failure, return libfabric error code </dd></dl>

</div>
</div>
<a class="anchor" id="aa87aea9145046aaacca12d020cd95c3c"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">size_t efa_rdm_pke_get_payload_offset </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structefa__rdm__pke.html">efa_rdm_pke</a> *&#160;</td>
          <td class="paramname"><em>pke</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>determine the payload offset of a received packet. </p>
<p>For a packet receive overwire, the payload is in the wiredata, immediately after header and optional user buffer information. This function find the offset of payoff in respect of wiredata.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">pke</td><td>received paket entry </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>an integer offset </dd></dl>

</div>
</div>
<a class="anchor" id="a25b95f35388c9960a72aebfc86b700f1"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">ssize_t efa_rdm_pke_init_payload_from_ope </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structefa__rdm__pke.html">efa_rdm_pke</a> *&#160;</td>
          <td class="paramname"><em>pke</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structefa__rdm__ope.html">efa_rdm_ope</a> *&#160;</td>
          <td class="paramname"><em>ope</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>payload_offset</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>segment_offset</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>data_size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>initialize the payload, payload_size, payload_mr and pkt_size of an outgoing packet </p>
<p>This function may or may not copy data from user's buffer to the packet's. If copy, "payload" will be pointing to a location inside packet entry's wiredata. Otherwise, "payload" will be pointing to a location insder user's buffer.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">pke</td><td>packet entry. Header must have been set when the function is called </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ope</td><td>operation entry that has user buffer information. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">payload_offset</td><td>the data offset in reference to pke-&gt;wiredata. This argument is used when the function decide to copy data from user's buffer to packet's wiredata. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">segment_offset</td><td>the data offset in reference to user's buffer </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">data_size</td><td>length of the data to be set up. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 on success, negative libfabric error code on failure. Possible error codes include: FI_EINVAL invalid segment offset. </dd></dl>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.5
</small></address>
</body>
</html>
